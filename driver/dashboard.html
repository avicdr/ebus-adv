<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - eBus</title>
    <link rel="stylesheet" href="../css/main.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard">
        <header class="dashboard-header">
            <div class="nav-brand">
                <i class="fas fa-steering-wheel"></i>
                <span>eBus - Driver Dashboard</span>
            </div>
            <div class="dashboard-nav">
                <a href="#" class="active" onclick="showSection('buses')">
                    <i class="fas fa-bus"></i> My Buses
                </a>
                <a href="#" onclick="showSection('add-bus')">
                    <i class="fas fa-plus"></i> Add Bus
                </a>
                <a href="#" onclick="showSection('location')">
                    <i class="fas fa-map-marker-alt"></i> Update Location
                </a>
                <a href="#" onclick="showSection('profile')">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="#" onclick="logout()" style="color: var(--error);">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </header>

        <div class="dashboard-content">
            <!-- My Buses Section -->
            <div id="buses-section" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">My Buses</h2>
                        <button class="btn btn-primary" onclick="showSection('add-bus')">
                            <i class="fas fa-plus"></i> Add New Bus
                        </button>
                    </div>
                    <div id="buses-list">
                        <div class="spinner" style="display: block; margin: 40px auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Add Bus Section -->
            <div id="add-bus-section" class="section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Add New Bus</h2>
                    </div>
                    
                    <form id="addBusForm">
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="busNumber">Bus Number</label>
                                <input type="text" id="busNumber" required placeholder="e.g., KA-05-1234">
                            </div>
                            
                            <div class="form-group">
                                <label for="operatorName">Operator Name</label>
                                <input type="text" id="operatorName" required placeholder="e.g., City Transport">
                            </div>
                            
                            <div class="form-group">
                                <label for="busType">Bus Type</label>
                                <select id="busType" required>
                                    <option value="">Select Type</option>
                                    <option value="AC">AC</option>
                                    <option value="Non-AC">Non-AC</option>
                                    <option value="Volvo">Volvo</option>
                                    <option value="Mini">Mini</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="capacity">Seating Capacity</label>
                                <input type="number" id="capacity" required min="10" max="60">
                            </div>
                            
                            <div class="form-group">
                                <label for="route">Route</label>
                                <input type="text" id="route" required placeholder="e.g., Bangalore - Mysore">
                            </div>
                            
                            <div class="form-group">
                                <label for="fare">Fare (â‚¹)</label>
                                <input type="number" id="fare" required min="10" step="10">
                            </div>
                            
                            <div class="form-group">
                                <label for="departureTime">Departure Time</label>
                                <input type="time" id="departureTime" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="arrivalTime">Arrival Time</label>
                                <input type="time" id="arrivalTime" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="contactNumber">Contact Number</label>
                                <input type="tel" id="contactNumber" required placeholder="+91 9876543210">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="description">Additional Details</label>
                            <textarea id="description" rows="3" placeholder="Any additional information about the bus service..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Bus
                        </button>
                    </form>
                </div>
            </div>

            <!-- Location Update Section -->
            <div id="location-section" class="section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Update Bus Location</h2>
                    </div>
                    
                    <div class="form-group">
                        <label for="busSelect">Select Bus</label>
                        <select id="busSelect">
                            <option value="">Choose a bus...</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label for="latitude">Latitude</label>
                            <input type="number" id="latitude" step="any" placeholder="e.g., 12.9716">
                        </div>
                        
                        <div class="form-group">
                            <label for="longitude">Longitude</label>
                            <input type="number" id="longitude" step="any" placeholder="e.g., 77.5946">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="currentLocation">Current Location</label>
                        <input type="text" id="currentLocation" placeholder="e.g., Near City Mall, MG Road">
                    </div>
                    
                    <div style="display: flex; gap: 16px;">
                        <button class="btn btn-secondary" onclick="getCurrentLocation()">
                            <i class="fas fa-crosshairs"></i> Use My Location
                        </button>
                        <button class="btn btn-primary" onclick="updateBusLocation()">
                            <i class="fas fa-map-marker-alt"></i> Update Location
                        </button>
                        <button class="btn btn-accent" onclick="startAutoTracking()">
                            <i class="fas fa-play"></i> Auto Track
                        </button>
                    </div>
                    
                    <div id="tracking-status" style="margin-top: 16px; padding: 12px; background: var(--gray-50); border-radius: 8px; display: none;">
                        <p style="margin: 0; color: var(--gray-700);">
                            <i class="fas fa-info-circle"></i> 
                            <span id="tracking-message">Auto-tracking disabled</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profile-section" class="section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Driver Profile</h2>
                    </div>
                    
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label for="profileName">Full Name</label>
                            <input type="text" id="profileName">
                        </div>
                        
                        <div class="form-group">
                            <label for="profileEmail">Email</label>
                            <input type="email" id="profileEmail" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="profilePhone">Phone</label>
                            <input type="tel" id="profilePhone">
                        </div>
                        
                        <div class="form-group">
                            <label for="licenseNumber">License Number</label>
                            <input type="text" id="licenseNumber" placeholder="DL Number">
                        </div>
                        
                        <div class="form-group">
                            <label for="experience">Experience (Years)</label>
                            <input type="number" id="experience" min="1" max="50">
                        </div>
                        
                        <div class="form-group">
                            <label for="profileJoined">Member Since</label>
                            <input type="text" id="profileJoined" readonly>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="updateProfile()">
                        <i class="fas fa-save"></i> Update Profile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/config/firebase.js"></script>
    <script src="../js/utils/helpers.js"></script>
    <script src="../js/modules/auth.js"></script>
    <script src="../js/modules/driver.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initializeDriverDashboard();
        });

        async function checkAuth() {
            const user = AuthModule.getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const userData = await AuthModule.getUserRole(user.uid);
                if (userData?.role !== 'driver') {
                    throw new Error('Access denied');
                }
            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = 'login.html';
            }
        }

        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.style.display = 'none');
            
            // Show selected section
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // Update nav active state
            const navLinks = document.querySelectorAll('.dashboard-nav a');
            navLinks.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function initializeDriverDashboard() {
            try {
                await loadDriverBuses();
                await loadDriverProfile();
            } catch (error) {
                console.error('Dashboard initialization error:', error);
            }
        }

        async function loadDriverBuses() {
            try {
                const buses = await DriverModule.getDriverBuses();
                displayBuses(buses);
                populateBusSelect(buses);
            } catch (error) {
                console.error('Error loading buses:', error);
                document.getElementById('buses-list').innerHTML = `
                    <p style="text-align: center; color: var(--error); padding: 40px;">
                        Error loading buses: ${error.message}
                    </p>
                `;
            }
        }

        function displayBuses(buses) {
            const container = document.getElementById('buses-list');
            
            if (buses.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: var(--gray-500); padding: 40px;">
                        No buses added yet. <a href="#" onclick="showSection('add-bus')" style="color: var(--primary);">Add your first bus</a>
                    </p>
                `;
                return;
            }
            
            container.innerHTML = buses.map(bus => `
                <div class="card" style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 8px; color: var(--gray-900);">${bus.busNumber}</h4>
                            <p style="color: var(--gray-600); margin-bottom: 4px;">
                                <i class="fas fa-building"></i> ${bus.operatorName}
                            </p>
                            <p style="color: var(--gray-600); margin-bottom: 4px;">
                                <i class="fas fa-route"></i> ${bus.route}
                            </p>
                            <p style="color: var(--gray-600); margin-bottom: 4px;">
                                <i class="fas fa-clock"></i> ${bus.departureTime} - ${bus.arrivalTime}
                            </p>
                            <p style="color: var(--gray-600);">
                                <i class="fas fa-bus"></i> ${bus.busType} | 
                                <i class="fas fa-users"></i> ${bus.capacity} seats | 
                                <i class="fas fa-rupee-sign"></i> ${bus.fare}
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-sm btn-secondary" onclick="editBus('${bus.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm" onclick="deleteBus('${bus.id}')" style="background: var(--error); color: white;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function populateBusSelect(buses) {
            const select = document.getElementById('busSelect');
            select.innerHTML = '<option value="">Choose a bus...</option>';
            
            buses.forEach(bus => {
                const option = document.createElement('option');
                option.value = bus.id;
                option.textContent = `${bus.busNumber} - ${bus.route}`;
                select.appendChild(option);
            });
        }

        // Form submission for adding bus
        document.getElementById('addBusForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const busData = {
                    busNumber: document.getElementById('busNumber').value,
                    operatorName: document.getElementById('operatorName').value,
                    busType: document.getElementById('busType').value,
                    capacity: parseInt(document.getElementById('capacity').value),
                    route: document.getElementById('route').value,
                    fare: parseInt(document.getElementById('fare').value),
                    departureTime: document.getElementById('departureTime').value,
                    arrivalTime: document.getElementById('arrivalTime').value,
                    contactNumber: document.getElementById('contactNumber').value,
                    description: document.getElementById('description').value
                };
                
                await DriverModule.addBus(busData);
                showAlert('Bus added successfully!', 'success');
                
                // Reset form and reload buses
                this.reset();
                await loadDriverBuses();
                showSection('buses');
                
            } catch (error) {
                console.error('Error adding bus:', error);
                showAlert('Error adding bus: ' + error.message, 'error');
            }
        });

        async function deleteBus(busId) {
            if (confirm('Are you sure you want to delete this bus?')) {
                try {
                    await DriverModule.deleteBus(busId);
                    showAlert('Bus deleted successfully!', 'success');
                    await loadDriverBuses();
                } catch (error) {
                    console.error('Error deleting bus:', error);
                    showAlert('Error deleting bus: ' + error.message, 'error');
                }
            }
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        document.getElementById('latitude').value = position.coords.latitude;
                        document.getElementById('longitude').value = position.coords.longitude;
                        
                        // Reverse geocoding simulation
                        const address = `Location: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;
                        document.getElementById('currentLocation').value = address;
                        
                        showAlert('Location obtained successfully!', 'success');
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        let errorMessage = 'Error getting location: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += 'Location access denied by user';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += 'Location information unavailable';
                                break;
                            case error.TIMEOUT:
                                errorMessage += 'Location request timed out';
                                break;
                            default:
                                errorMessage += 'Unknown error occurred';
                        }
                        showAlert(errorMessage, 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                showAlert('Geolocation is not supported by this browser', 'error');
            }
        }

        let autoTrackingInterval = null;
        let isAutoTracking = false;

        function startAutoTracking() {
            const busId = document.getElementById('busSelect').value;
            if (!busId) {
                showAlert('Please select a bus first', 'warning');
                return;
            }
            
            if (isAutoTracking) {
                // Stop auto tracking
                clearInterval(autoTrackingInterval);
                isAutoTracking = false;
                document.querySelector('button[onclick="startAutoTracking()"]').innerHTML = '<i class="fas fa-play"></i> Auto Track';
                document.getElementById('tracking-status').style.display = 'none';
                showAlert('Auto-tracking stopped', 'info');
                return;
            }
            
            // Start auto tracking
            isAutoTracking = true;
            document.querySelector('button[onclick="startAutoTracking()"]').innerHTML = '<i class="fas fa-stop"></i> Stop Auto Track';
            document.getElementById('tracking-status').style.display = 'block';
            document.getElementById('tracking-message').textContent = 'Auto-tracking every 30 seconds...';
            
            // Update location immediately
            autoUpdateLocation();
            
            // Set interval for auto updates
            autoTrackingInterval = setInterval(autoUpdateLocation, 30000); // Every 30 seconds
            
            showAlert('Auto-tracking started! Location will update every 30 seconds', 'success');
        }

        function autoUpdateLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const busId = document.getElementById('busSelect').value;
                        if (!busId) return;
                        
                        try {
                            await DriverModule.updateBusLocation(busId, {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                address: `Auto-tracked: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`,
                                lastUpdated: new Date().toISOString(),
                                accuracy: position.coords.accuracy
                            });
                            
                            document.getElementById('tracking-message').textContent = 
                                `Last updated: ${new Date().toLocaleTimeString()} (Auto-tracking active)`;
                            
                        } catch (error) {
                            console.error('Auto-tracking error:', error);
                        }
                    },
                    (error) => {
                        console.error('Auto-tracking geolocation error:', error);
                        document.getElementById('tracking-message').textContent = 
                            'Auto-tracking error - check location permissions';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 30000
                    }
                );
            }
        }

        async function updateBusLocation() {
            const busId = document.getElementById('busSelect').value;
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            const address = document.getElementById('currentLocation').value;
            
            if (!busId) {
                showAlert('Please select a bus', 'warning');
                return;
            }
            
            if (!latitude || !longitude) {
                showAlert('Please provide location coordinates', 'warning');
                return;
            }
            
            try {
                await DriverModule.updateBusLocation(busId, {
                    latitude: parseFloat(latitude),
                    longitude: parseFloat(longitude),
                    address,
                    lastUpdated: new Date().toISOString(),
                    manual: true
                });
                
                showAlert('Bus location updated successfully!', 'success');
                
                // Clear form
                document.getElementById('latitude').value = '';
                document.getElementById('longitude').value = '';
                document.getElementById('currentLocation').value = '';
                
            } catch (error) {
                console.error('Error updating location:', error);
                showAlert('Error updating location: ' + error.message, 'error');
            }
        }

        async function loadDriverProfile() {
            try {
                const user = AuthModule.getCurrentUser();
                if (user) {
                    const userData = await DriverModule.getDriverProfile(user.uid);
                    if (userData) {
                        document.getElementById('profileName').value = userData.fullName || '';
                        document.getElementById('profileEmail').value = userData.email || user.email;
                        document.getElementById('profilePhone').value = userData.phone || '';
                        document.getElementById('licenseNumber').value = userData.licenseNumber || '';
                        document.getElementById('experience').value = userData.experience || '';
                        if (userData.createdAt) {
                            document.getElementById('profileJoined').value = new Date(userData.createdAt).toLocaleDateString();
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function updateProfile() {
            try {
                const profileData = {
                    fullName: document.getElementById('profileName').value,
                    phone: document.getElementById('profilePhone').value,
                    licenseNumber: document.getElementById('licenseNumber').value,
                    experience: parseInt(document.getElementById('experience').value) || 0
                };
                
                await DriverModule.updateProfile(profileData);
                showAlert('Profile updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating profile:', error);
                showAlert('Error updating profile: ' + error.message, 'error');
            }
        }

        function logout() {
            AuthModule.logout();
            
            // Stop auto tracking if active
            if (isAutoTracking) {
                clearInterval(autoTrackingInterval);
                isAutoTracking = false;
            }
            
            window.location.href = '../index.html';
        }
    </script>
</body>
</html>