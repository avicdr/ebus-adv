<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - eBus</title>
    <link rel="stylesheet" href="../css/main.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard">
        <header class="dashboard-header">
            <div class="nav-brand">
                <i class="fas fa-cog"></i>
                <span>eBus - Admin Dashboard</span>
            </div>
            <div class="dashboard-nav">
                <a href="#" class="active" onclick="showSection('overview')">
                    <i class="fas fa-chart-line"></i> Overview
                </a>
                <a href="#" onclick="showSection('drivers')">
                    <i class="fas fa-users"></i> Drivers
                </a>
                <a href="#" onclick="showSection('users')">
                    <i class="fas fa-user-friends"></i> Users
                </a>
                <a href="#" onclick="showSection('buses')">
                    <i class="fas fa-bus"></i> All Buses
                </a>
                <a href="#" onclick="showSection('create-driver')">
                    <i class="fas fa-plus"></i> Add Driver
                </a>
                <a href="#" onclick="logout()" style="color: var(--error);">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </header>

        <div class="dashboard-content">
            <!-- Overview Section -->
            <div id="overview-section" class="section">
                <div class="grid grid-3">
                    <div class="card">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <h3 style="margin-bottom: 8px; color: var(--gray-600); font-size: 14px; text-transform: uppercase;">Total Users</h3>
                                <p style="font-size: 32px; font-weight: 700; color: var(--primary);" id="total-users">-</p>
                            </div>
                            <i class="fas fa-users" style="font-size: 48px; color: var(--primary); opacity: 0.3;"></i>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <h3 style="margin-bottom: 8px; color: var(--gray-600); font-size: 14px; text-transform: uppercase;">Total Drivers</h3>
                                <p style="font-size: 32px; font-weight: 700; color: var(--secondary);" id="total-drivers">-</p>
                            </div>
                            <i class="fas fa-steering-wheel" style="font-size: 48px; color: var(--secondary); opacity: 0.3;"></i>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <h3 style="margin-bottom: 8px; color: var(--gray-600); font-size: 14px; text-transform: uppercase;">Total Buses</h3>
                                <p style="font-size: 32px; font-weight: 700; color: var(--accent);" id="total-buses">-</p>
                            </div>
                            <i class="fas fa-bus" style="font-size: 48px; color: var(--accent); opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Activities</h2>
                    </div>
                    <div id="recent-activities">
                        <div class="spinner" style="display: block; margin: 40px auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Drivers Section -->
            <div id="drivers-section" class="section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Driver Management</h2>
                        <button class="btn btn-primary" onclick="showSection('create-driver')">
                            <i class="fas fa-plus"></i> Add New Driver
                        </button>
                    </div>
                    <div id="drivers-list">
                        <div class="spinner" style="display: block; margin: 40px auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users-section" class="section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">User Management</h2>
                    </div>
                    <div id="users-list">
                        <div class="spinner" style="display: block; margin: 40px auto;"></div>
                    </div>
                </div>
            </div>

            <!-- All Buses Section -->
            <div id="buses-section" class="section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">All Buses</h2>
                    </div>
                    <div id="all-buses-list">
                        <div class="spinner" style="display: block; margin: 40px auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Create Driver Section -->
            <div id="create-driver-section" class="section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Create Driver Account</h2>
                    </div>
                    
                    <form id="createDriverForm">
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="driverName">Full Name</label>
                                <input type="text" id="driverName" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="driverEmail">Email Address</label>
                                <input type="email" id="driverEmail" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="driverPhone">Phone Number</label>
                                <input type="tel" id="driverPhone" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="driverPassword">Password</label>
                                <input type="password" id="driverPassword" required minlength="6">
                            </div>
                            
                            <div class="form-group">
                                <label for="licenseNumber">License Number</label>
                                <input type="text" id="licenseNumber" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="experience">Experience (Years)</label>
                                <input type="number" id="experience" min="1" max="50">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="driverAddress">Address</label>
                            <textarea id="driverAddress" rows="3"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> Create Driver Account
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/config/firebase.js"></script>
    <script src="../js/utils/helpers.js"></script>
    <script src="../js/modules/auth.js"></script>
    <script src="../js/modules/admin.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initializeAdminDashboard();
        });

        async function checkAuth() {
            const user = AuthModule.getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const userData = await AuthModule.getUserRole(user.uid);
                if (userData?.role !== 'admin') {
                    throw new Error('Access denied');
                }
            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = 'login.html';
            }
        }

        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.style.display = 'none');
            
            // Show selected section
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // Update nav active state
            const navLinks = document.querySelectorAll('.dashboard-nav a');
            navLinks.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            
            // Load data based on section
            switch(sectionName) {
                case 'drivers':
                    loadDrivers();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'buses':
                    loadAllBuses();
                    break;
            }
        }

        async function initializeAdminDashboard() {
            try {
                await loadOverviewStats();
                await loadRecentActivities();
            } catch (error) {
                console.error('Dashboard initialization error:', error);
            }
        }

        async function loadOverviewStats() {
            try {
                const stats = await AdminModule.getOverviewStats();
                document.getElementById('total-users').textContent = stats.totalUsers;
                document.getElementById('total-drivers').textContent = stats.totalDrivers;
                document.getElementById('total-buses').textContent = stats.totalBuses;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadRecentActivities() {
            try {
                const activities = await AdminModule.getRecentActivities();
                const container = document.getElementById('recent-activities');
                
                if (activities.length === 0) {
                    container.innerHTML = `
                        <p style="text-align: center; color: var(--gray-500); padding: 40px;">
                            No recent activities
                        </p>
                    `;
                    return;
                }
                
                container.innerHTML = activities.map(activity => `
                    <div style="display: flex; align-items: center; padding: 16px; border-bottom: 1px solid var(--gray-200);">
                        <i class="fas fa-${getActivityIcon(activity.type)}" style="color: var(--${getActivityColor(activity.type)}); margin-right: 16px;"></i>
                        <div style="flex: 1;">
                            <p style="margin-bottom: 4px; color: var(--gray-900);">${activity.description}</p>
                            <p style="font-size: 12px; color: var(--gray-500);">${formatDate(activity.timestamp)}</p>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading activities:', error);
                document.getElementById('recent-activities').innerHTML = `
                    <p style="text-align: center; color: var(--error); padding: 40px;">
                        Error loading activities
                    </p>
                `;
            }
        }

        function getActivityIcon(type) {
            const icons = {
                'driver_created': 'user-plus',
                'bus_added': 'bus',
                'user_registered': 'user-check',
                'location_updated': 'map-marker-alt'
            };
            return icons[type] || 'info-circle';
        }

        function getActivityColor(type) {
            const colors = {
                'driver_created': 'secondary',
                'bus_added': 'accent',
                'user_registered': 'primary',
                'location_updated': 'success'
            };
            return colors[type] || 'gray-500';
        }

        async function loadDrivers() {
            try {
                const drivers = await AdminModule.getAllDrivers();
                displayDrivers(drivers);
            } catch (error) {
                console.error('Error loading drivers:', error);
                document.getElementById('drivers-list').innerHTML = `
                    <p style="text-align: center; color: var(--error); padding: 40px;">
                        Error loading drivers: ${error.message}
                    </p>
                `;
            }
        }

        function displayDrivers(drivers) {
            const container = document.getElementById('drivers-list');
            
            if (drivers.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: var(--gray-500); padding: 40px;">
                        No drivers found. <a href="#" onclick="showSection('create-driver')" style="color: var(--primary);">Create first driver</a>
                    </p>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>License</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${drivers.map(driver => `
                            <tr>
                                <td>${driver.fullName || 'N/A'}</td>
                                <td>${driver.email}</td>
                                <td>${driver.phone || 'N/A'}</td>
                                <td>${driver.licenseNumber || 'N/A'}</td>
                                <td>
                                    <span class="badge badge-success">Active</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="editDriver('${driver.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm" onclick="deleteDriver('${driver.id}')" 
                                            style="background: var(--error); color: white; margin-left: 8px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function loadUsers() {
            try {
                const users = await AdminModule.getAllUsers();
                displayUsers(users);
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-list').innerHTML = `
                    <p style="text-align: center; color: var(--error); padding: 40px;">
                        Error loading users: ${error.message}
                    </p>
                `;
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('users-list');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: var(--gray-500); padding: 40px;">
                        No users found
                    </p>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Joined</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.fullName || 'N/A'}</td>
                                <td>${user.email}</td>
                                <td>${user.phone || 'N/A'}</td>
                                <td>${formatDate(user.createdAt)}</td>
                                <td>
                                    <span class="badge badge-success">Active</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function loadAllBuses() {
            try {
                const buses = await AdminModule.getAllBuses();
                displayAllBuses(buses);
            } catch (error) {
                console.error('Error loading buses:', error);
                document.getElementById('all-buses-list').innerHTML = `
                    <p style="text-align: center; color: var(--error); padding: 40px;">
                        Error loading buses: ${error.message}
                    </p>
                `;
            }
        }

        function displayAllBuses(buses) {
            const container = document.getElementById('all-buses-list');
            
            if (buses.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: var(--gray-500); padding: 40px;">
                        No buses found
                    </p>
                `;
                return;
            }
            
            container.innerHTML = buses.map(bus => `
                <div class="card" style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 8px; color: var(--gray-900);">${bus.busNumber}</h4>
                            <p style="color: var(--gray-600); margin-bottom: 4px;">
                                <i class="fas fa-building"></i> ${bus.operatorName}
                            </p>
                            <p style="color: var(--gray-600); margin-bottom: 4px;">
                                <i class="fas fa-route"></i> ${bus.route}
                            </p>
                            <p style="color: var(--gray-600); margin-bottom: 4px;">
                                <i class="fas fa-clock"></i> ${bus.departureTime} - ${bus.arrivalTime}
                            </p>
                            <p style="color: var(--gray-600);">
                                <i class="fas fa-bus"></i> ${bus.busType} | 
                                <i class="fas fa-users"></i> ${bus.capacity} seats | 
                                <i class="fas fa-rupee-sign"></i> ${bus.fare}
                            </p>
                        </div>
                        <div>
                            <span class="badge badge-success">Active</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Create driver form submission
        document.getElementById('createDriverForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const driverData = {
                    fullName: document.getElementById('driverName').value,
                    email: document.getElementById('driverEmail').value,
                    phone: document.getElementById('driverPhone').value,
                    password: document.getElementById('driverPassword').value,
                    licenseNumber: document.getElementById('licenseNumber').value,
                    experience: parseInt(document.getElementById('experience').value) || 0,
                    address: document.getElementById('driverAddress').value,
                    role: 'driver'
                };
                
                await AdminModule.createDriver(driverData);
                showAlert('Driver account created successfully!', 'success');
                
                // Reset form
                this.reset();
                
                // Refresh overview stats
                await loadOverviewStats();
                
                // Show drivers section
                showSection('drivers');
                
            } catch (error) {
                console.error('Error creating driver:', error);
                showAlert('Error creating driver: ' + error.message, 'error');
            }
        });

        async function deleteDriver(driverId) {
            if (confirm('Are you sure you want to delete this driver account?')) {
                try {
                    await AdminModule.deleteDriver(driverId);
                    showAlert('Driver deleted successfully!', 'success');
                    await loadDrivers();
                    await loadOverviewStats();
                } catch (error) {
                    console.error('Error deleting driver:', error);
                    showAlert('Error deleting driver: ' + error.message, 'error');
                }
            }
        }

        function logout() {
            AuthModule.logout();
            window.location.href = '../index.html';
        }
    </script>
</body>
</html>